stages:
  - debug
  - build

variables:
  ANDROID_HOME: "/usr/local/share/android-sdk"
  ANDROID_SDK_ROOT: "/usr/local/share/android-sdk"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  GIT_STRATEGY: clone
  GIT_DEPTH: 0

before_script:
  - apt-get update && apt-get install -y openjdk-17-jdk unzip wget curl
  - dotnet --info
  - echo "Installing Android SDK to $ANDROID_HOME"
  - mkdir -p $ANDROID_HOME
  - cd $ANDROID_HOME
  - wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
  - unzip -q commandlinetools-linux-11076708_latest.zip
  - mkdir -p cmdline-tools/latest
  - mv cmdline-tools/* cmdline-tools/latest/ || true
  - rm commandlinetools-linux-11076708_latest.zip
  - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
  - export PATH=$ANDROID_HOME/platform-tools:$PATH
  - yes | sdkmanager --licenses || true
  - sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
  - echo "Returning to project directory"
  - cd $CI_PROJECT_DIR
  - echo "Installing .NET Android workload"
  - dotnet workload install android

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - ~/.nuget/packages/

debug_files:
  stage: debug
  image: mcr.microsoft.com/dotnet/sdk:8.0
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 1
  script:
    - echo "=== COMPLETE FILE STRUCTURE DEBUG ==="
    - echo "Current working directory:"
    - pwd
    - echo "CI_PROJECT_DIR variable:"
    - echo $CI_PROJECT_DIR
    - echo "Environment variables:"
    - env | grep -E "(CI_|GITLAB_|GIT_)" | sort
    - echo "Root directory contents:"
    - ls -la
    - echo "All .csproj files in project:"
    - find . -name "*.csproj" -type f || echo "No .csproj files found"
    - echo "All directories:"
    - find . -type d -maxdepth 2
    - echo "GltronMobileGame directory check:"
    - ls -la GltronMobileGame/ || echo "GltronMobileGame directory not found"
    - echo "Specific file check:"
    - ls -la GltronMobileGame/GltronAndroid.csproj || echo "GltronAndroid.csproj not found"
    - echo "Git status:"
    - git status || echo "Git not available"
    - echo "Android SDK location check:"
    - ls -la $ANDROID_HOME || echo "Android SDK not found at $ANDROID_HOME"
    - echo "=== END DEBUG ==="

build_debug:
  stage: build
  needs: ["debug_files"]
  image: mcr.microsoft.com/dotnet/sdk:8.0
  timeout: 30m
  retry: 1
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 1
  script:
    - echo "=== DEBUGGING FILE STRUCTURE ==="
    - pwd
    - echo "Root directory contents:"
    - ls -la
    - echo "Looking for .csproj files:"
    - find . -name "*.csproj" -type f
    - echo "Looking for GltronMobileGame directory:"
    - ls -la GltronMobileGame/ || echo "GltronMobileGame directory not found"
    - echo "Checking if GltronAndroid.csproj exists:"
    - ls -la GltronMobileGame/GltronAndroid.csproj || echo "GltronAndroid.csproj not found"
    - echo "=== END DEBUGGING ==="
    - echo "Restoring dependencies"
    - dotnet restore GltronMobileGame/GltronAndroid.csproj
    - echo "Building Debug APK"
    - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
    - dotnet publish GltronMobileGame/GltronAndroid.csproj -c Debug -f net8.0-android --no-restore --verbosity minimal -p:AndroidSdkDirectory=$ANDROID_HOME
  artifacts:
    name: "gltron-mobile-debug-${CI_COMMIT_SHORT_SHA}"
    paths:
      - GltronMobileGame/bin/Debug/net8.0-android/publish/*.apk
    expire_in: 30 days

build_release:
  stage: build
  needs: ["debug_files"]
  image: mcr.microsoft.com/dotnet/sdk:8.0
  timeout: 30m
  retry: 1
  variables:
    GIT_STRATEGY: clone
    GIT_DEPTH: 1
  script:
    - echo "=== DEBUGGING FILE STRUCTURE ==="
    - pwd
    - echo "Root directory contents:"
    - ls -la
    - echo "Looking for .csproj files:"
    - find . -name "*.csproj" -type f
    - echo "Looking for GltronMobileGame directory:"
    - ls -la GltronMobileGame/ || echo "GltronMobileGame directory not found"
    - echo "Checking if GltronAndroid.csproj exists:"
    - ls -la GltronMobileGame/GltronAndroid.csproj || echo "GltronAndroid.csproj not found"
    - echo "=== END DEBUGGING ==="
    - echo "Restoring dependencies"
    - dotnet restore GltronMobileGame/GltronAndroid.csproj
    - echo "Building Release APK"
    - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
    - dotnet publish GltronMobileGame/GltronAndroid.csproj -c Release -f net8.0-android --no-restore --verbosity minimal -p:AndroidSdkDirectory=$ANDROID_HOME
  artifacts:
    name: "gltron-mobile-release-${CI_COMMIT_SHORT_SHA}"
    paths:
      - GltronMobileGame/bin/Release/net8.0-android/publish/*.apk
    expire_in: 30 days
