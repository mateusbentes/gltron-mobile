stages:
  - build
  - test

variables:
  ANDROID_HOME: "/usr/local/share/android-sdk"
  ANDROID_SDK_ROOT: "/usr/local/share/android-sdk"
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
  DOTNET_CLI_TELEMETRY_OPTOUT: "1"
  GIT_STRATEGY: clone
  GIT_DEPTH: 0

before_script:
  - apt-get update && apt-get install -y openjdk-17-jdk unzip wget curl libc6-dev
  - dotnet --info
  - echo "Installing Android SDK to $ANDROID_HOME"
  - mkdir -p $ANDROID_HOME
  - cd $ANDROID_HOME
  - wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip
  - unzip -q commandlinetools-linux-11076708_latest.zip
  - mkdir -p cmdline-tools/latest
  - mv cmdline-tools/* cmdline-tools/latest/ || true
  - rm commandlinetools-linux-11076708_latest.zip
  - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
  - export PATH=$ANDROID_HOME/platform-tools:$PATH
  - yes | sdkmanager --licenses || true
  - echo "Installing Android SDK components..."
  - sdkmanager "platform-tools"
  - sdkmanager "platforms;android-34"
  - sdkmanager "platforms;android-36"
  - sdkmanager "build-tools;34.0.0"
  - sdkmanager "build-tools;36.0.0"
  - echo "Verifying Android API 36 installation:"
  - ls -la $ANDROID_HOME/platforms/
  - ls -la $ANDROID_HOME/platforms/android-36/ || echo "Android API 36 directory not found"
  - echo "Available platforms:"
  - sdkmanager --list_installed | grep "platforms;android-"
  - echo "Returning to project directory"
  - cd $CI_PROJECT_DIR
  - echo "Installing .NET Android workload"
  - dotnet workload install android

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - ~/.nuget/packages/

build_debug:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0-noble
  timeout: 30m
  retry: 1
  script:
    - echo "Checking GLIBC version"
    - ldd --version
    - echo "Restoring dependencies"
    - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
    - dotnet restore GltronMobileGame/GltronAndroid.csproj
    - echo "Verifying Android SDK setup"
    - echo "ANDROID_HOME is $ANDROID_HOME"
    - echo "Android platforms available:"
    - ls -la $ANDROID_HOME/platforms/ || echo "No platforms directory"
    - echo "Installing missing Android dependencies"
    - dotnet build GltronMobileGame/GltronAndroid.csproj -t:InstallAndroidDependencies -f net8.0-android -p:AndroidSdkDirectory=$ANDROID_HOME -v:normal || echo "InstallAndroidDependencies failed, continuing..."
    - echo "Building Debug APK"
    - dotnet publish GltronMobileGame/GltronAndroid.csproj -c Debug -f net8.0-android --no-restore -p:AndroidSdkDirectory=$ANDROID_HOME -p:EnableMGCBItems=false || echo "Build with MGCB failed, trying without content building..."
    - dotnet publish GltronMobileGame/GltronAndroid.csproj -c Debug -f net8.0-android --no-restore -p:AndroidSdkDirectory=$ANDROID_HOME -p:EnableMGCBItems=false -p:UseMonoGamePipeline=false
  artifacts:
    name: "gltron-mobile-debug-${CI_COMMIT_SHORT_SHA}"
    paths:
      - GltronMobileGame/bin/Debug/net8.0-android/publish/*.apk
    expire_in: 30 days

build_release:
  stage: build
  image: mcr.microsoft.com/dotnet/sdk:8.0-noble
  timeout: 30m
  retry: 1
  script:
    - echo "Checking GLIBC version"
    - ldd --version
    - echo "Restoring dependencies"
    - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
    - dotnet restore GltronMobileGame/GltronAndroid.csproj
    - echo "Verifying Android SDK setup"
    - echo "ANDROID_HOME is $ANDROID_HOME"
    - echo "Android platforms available:"
    - ls -la $ANDROID_HOME/platforms/ || echo "No platforms directory"
    - echo "Installing missing Android dependencies"
    - dotnet build GltronMobileGame/GltronAndroid.csproj -t:InstallAndroidDependencies -f net8.0-android -p:AndroidSdkDirectory=$ANDROID_HOME -v:normal || echo "InstallAndroidDependencies failed, continuing..."
    - echo "Building Release APK"
    - dotnet publish GltronMobileGame/GltronAndroid.csproj -c Release -f net8.0-android --no-restore -p:AndroidSdkDirectory=$ANDROID_HOME -p:EnableMGCBItems=false || echo "Build with MGCB failed, trying without content building..."
    - dotnet publish GltronMobileGame/GltronAndroid.csproj -c Release -f net8.0-android --no-restore -p:AndroidSdkDirectory=$ANDROID_HOME -p:EnableMGCBItems=false -p:UseMonoGamePipeline=false
  artifacts:
    name: "gltron-mobile-release-${CI_COMMIT_SHORT_SHA}"
    paths:
      - GltronMobileGame/bin/Release/net8.0-android/publish/*.apk
    expire_in: 30 days

test_apk_debug:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0-noble
  needs: ["build_debug"]
  script:
    - echo "Testing Debug APK"
    - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
    - echo "Finding APK files..."
    - find GltronMobileGame/bin/Debug -name "*.apk" -type f
    - APK_FILE=$(find GltronMobileGame/bin/Debug -name "*.apk" -type f | head -1)
    - echo "Testing APK $APK_FILE"
    - |
      if [ -f "$APK_FILE" ]; then
        echo "APK file exists: $APK_FILE"
        ls -lh "$APK_FILE"
        echo "APK size: $(du -h "$APK_FILE" | cut -f1)"
        echo "APK analysis with aapt:"
        aapt dump badging "$APK_FILE" | head -20 || echo "aapt analysis failed"
        echo "APK contents:"
        aapt list "$APK_FILE" | head -20 || echo "aapt list failed"
        echo "Debug APK validation completed"
      else
        echo "No APK file found"
        exit 1
      fi

test_apk_release:
  stage: test
  image: mcr.microsoft.com/dotnet/sdk:8.0-noble
  needs: ["build_release"]
  script:
    - echo "Testing Release APK"
    - export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
    - echo "Finding APK files..."
    - find GltronMobileGame/bin/Release -name "*.apk" -type f
    - APK_FILE=$(find GltronMobileGame/bin/Release -name "*.apk" -type f | head -1)
    - echo "Testing APK $APK_FILE"
    - |
      if [ -f "$APK_FILE" ]; then
        echo "APK file exists: $APK_FILE"
        ls -lh "$APK_FILE"
        echo "APK size: $(du -h "$APK_FILE" | cut -f1)"
        echo "APK analysis with aapt:"
        aapt dump badging "$APK_FILE" | head -20 || echo "aapt analysis failed"
        echo "APK contents:"
        aapt list "$APK_FILE" | head -20 || echo "aapt list failed"
        echo "Checking for required libraries:"
        aapt list "$APK_FILE" | grep -E "\.(so|dll)$" || echo "No native libraries found"
        echo "Checking for game assets:"
        aapt list "$APK_FILE" | grep -E "\.(png|jpg|ogg|mp3|xnb)$" | head -10 || echo "No game assets found"
        echo "Release APK validation completed"
      else
        echo "No APK file found"
        exit 1
      fi
